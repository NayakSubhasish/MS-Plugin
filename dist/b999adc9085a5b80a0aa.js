/*! For license information please see b999adc9085a5b80a0aa.js.LICENSE.txt */
function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function(){return t};var e,t={},o=Object.prototype,n=o.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",r=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function s(e,t,o,n){return Object.defineProperty(e,t,{value:o,enumerable:!n,configurable:!n,writable:!n})}try{s({},"")}catch(e){s=function(e,t,o){return e[t]=o}}function c(t,o,n,i){var a=o&&o.prototype instanceof g?o:g,r=Object.create(a.prototype);return s(r,"_invoke",function(t,o,n){var i=1;return function(a,r){if(3===i)throw Error("Generator is already running");if(4===i){if("throw"===a)throw r;return{value:e,done:!0}}for(n.method=a,n.arg=r;;){var l=n.delegate;if(l){var s=O(l,n);if(s){if(s===u)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(1===i)throw i=4,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i=3;var c=d(t,o,n);if("normal"===c.type){if(i=n.done?4:2,c.arg===u)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(i=4,n.method="throw",n.arg=c.arg)}}}(t,n,new I(i||[])),!0),r}function d(e,t,o){try{return{type:"normal",arg:e.call(t,o)}}catch(e){return{type:"throw",arg:e}}}t.wrap=c;var u={};function g(){}function f(){}function m(){}var p={};s(p,a,(function(){return this}));var y=Object.getPrototypeOf,v=y&&y(y(S([])));v&&v!==o&&n.call(v,a)&&(p=v);var h=m.prototype=g.prototype=Object.create(p);function w(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function E(e,t){function o(i,a,r,l){var s=d(e[i],e,a);if("throw"!==s.type){var c=s.arg,u=c.value;return u&&"object"==_typeof(u)&&n.call(u,"__await")?t.resolve(u.__await).then((function(e){o("next",e,r,l)}),(function(e){o("throw",e,r,l)})):t.resolve(u).then((function(e){c.value=e,r(c)}),(function(e){return o("throw",e,r,l)}))}l(s.arg)}var i;s(this,"_invoke",(function(e,n){function a(){return new t((function(t,i){o(e,n,t,i)}))}return i=i?i.then(a,a):a()}),!0)}function O(t,o){var n=o.method,i=t.i[n];if(i===e)return o.delegate=null,"throw"===n&&t.i.return&&(o.method="return",o.arg=e,O(t,o),"throw"===o.method)||"return"!==n&&(o.method="throw",o.arg=new TypeError("The iterator does not provide a '"+n+"' method")),u;var a=d(i,t.i,o.arg);if("throw"===a.type)return o.method="throw",o.arg=a.arg,o.delegate=null,u;var r=a.arg;return r?r.done?(o[t.r]=r.value,o.next=t.n,"return"!==o.method&&(o.method="next",o.arg=e),o.delegate=null,u):r:(o.method="throw",o.arg=new TypeError("iterator result is not an object"),o.delegate=null,u)}function b(e){this.tryEntries.push(e)}function A(t){var o=t[4]||{};o.type="normal",o.arg=e,t[4]=o}function I(e){this.tryEntries=[[-1]],e.forEach(b,this),this.reset(!0)}function S(t){if(null!=t){var o=t[a];if(o)return o.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,r=function o(){for(;++i<t.length;)if(n.call(t,i))return o.value=t[i],o.done=!1,o;return o.value=e,o.done=!0,o};return r.next=r}}throw new TypeError(_typeof(t)+" is not iterable")}return f.prototype=m,s(h,"constructor",m),s(m,"constructor",f),f.displayName=s(m,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===f||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,s(e,l,"GeneratorFunction")),e.prototype=Object.create(h),e},t.awrap=function(e){return{__await:e}},w(E.prototype),s(E.prototype,r,(function(){return this})),t.AsyncIterator=E,t.async=function(e,o,n,i,a){void 0===a&&(a=Promise);var r=new E(c(e,o,n,i),a);return t.isGeneratorFunction(o)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},w(h),s(h,l,"Generator"),s(h,a,(function(){return this})),s(h,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),o=[];for(var n in t)o.unshift(n);return function e(){for(;o.length;)if((n=o.pop())in t)return e.value=n,e.done=!1,e;return e.done=!0,e}},t.values=S,I.prototype={constructor:I,reset:function(t){if(this.prev=this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(A),!t)for(var o in this)"t"===o.charAt(0)&&n.call(this,o)&&!isNaN(+o.slice(1))&&(this[o]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0][4];if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var o=this;function n(e){r.type="throw",r.arg=t,o.next=e}for(var i=o.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],r=a[4],l=this.prev,s=a[1],c=a[2];if(-1===a[0])return n("end"),!1;if(!s&&!c)throw Error("try statement without catch or finally");if(null!=a[0]&&a[0]<=l){if(l<s)return this.method="next",this.arg=e,n(s),!0;if(l<c)return n(c),!1}}},abrupt:function(e,t){for(var o=this.tryEntries.length-1;o>=0;--o){var n=this.tryEntries[o];if(n[0]>-1&&n[0]<=this.prev&&this.prev<n[2]){var i=n;break}}i&&("break"===e||"continue"===e)&&i[0]<=t&&t<=i[2]&&(i=null);var a=i?i[4]:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i[2],u):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var o=this.tryEntries[t];if(o[2]===e)return this.complete(o[4],o[3]),A(o),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var o=this.tryEntries[t];if(o[0]===e){var n=o[4];if("throw"===n.type){var i=n.arg;A(o)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,o,n){return this.delegate={i:S(t),r:o,n:n},"next"===this.method&&(this.arg=e),u}},t}function asyncGeneratorStep(e,t,o,n,i,a,r){try{var l=e[a](r),s=l.value}catch(e){return void o(e)}l.done?t(s):Promise.resolve(s).then(n,i)}function _asyncToGenerator(e){return function(){var t=this,o=arguments;return new Promise((function(n,i){var a=e.apply(t,o);function r(e){asyncGeneratorStep(a,n,i,r,l,"next",e)}function l(e){asyncGeneratorStep(a,n,i,r,l,"throw",e)}r(void 0)}))}}console.log("üöÄ COMMANDS.JS LOADED - Email validation system initializing..."),console.log("üìÖ Load time:",(new Date).toISOString());var getSuggestedReply,BOTATWORK_API_KEY="e80f5458c550f5b85ef56175b789468a",BOTATWORK_API_URL="https://api.botatwork.com/trigger-task/b6f44edd-8140-4084-881e-2c11c403c082";try{"undefined"!=typeof window&&window.getSuggestedReply?(getSuggestedReply=window.getSuggestedReply,console.log("‚úÖ getSuggestedReply imported from window")):console.log("‚ö†Ô∏è getSuggestedReply not found on window, will define locally")}catch(e){console.error("‚ùå Error importing getSuggestedReply:",e)}getSuggestedReply||(getSuggestedReply=function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var o,n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("üîß Using local getSuggestedReply implementation"),console.log("üì§ API params:",t),e.prev=2,e.next=5,fetch(BOTATWORK_API_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(BOTATWORK_API_KEY)},body:JSON.stringify(t)});case 5:if((o=e.sent).ok){e.next=8;break}throw new Error("HTTP error! status: ".concat(o.status));case 8:return e.next=10,o.json();case 10:return n=e.sent,console.log("üì• API response:",n),e.abrupt("return",n.result||n.response||n.content||"Enhanced email content generated");case 15:throw e.prev=15,e.t0=e.catch(2),console.error("‚ùå Local API call failed:",e.t0),e.t0;case 19:case"end":return e.stop()}}),e,null,[[2,15]])})));return function(t){return e.apply(this,arguments)}}(),console.log("‚úÖ Local getSuggestedReply implementation ready"));try{import("../taskpane/botAtWorkApi.js").then((function(e){getSuggestedReply=e.getSuggestedReply}))}catch(e){console.log("Could not import getSuggestedReply, will use direct API calls")}var REQUIRED_KEYWORDS={agenda:{keywords:["agenda","meeting agenda","topics to discuss","discussion points"],category:"Meeting Structure",suggestions:["agenda","meeting topics","discussion items"]},action:{keywords:["action item","action required","next steps","follow up","todo"],category:"Action Items",suggestions:["action items","next steps","follow-up required"]},timeline:{keywords:["deadline","due date","timeline","schedule","by when"],category:"Timeline",suggestions:["deadline","timeline","completion date"]},participants:{keywords:["attendees","participants","who should attend","invitees"],category:"Participants",suggestions:["attendees","participants","invitees"]},greeting:{keywords:["dear","hello","hi","good morning","good afternoon"],category:"Greeting",suggestions:["Dear","Hello","Hi"]},closing:{keywords:["regards","best regards","sincerely","thank you","thanks"],category:"Closing",suggestions:["Best regards","Thank you","Sincerely"]}},validationState={lastValidationTime:0,lastEmailBody:"",validationInProgress:!1};function validateEmail(e){if(console.log("üöÄüöÄüöÄ EMAIL VALIDATION TRIGGERED - OnMessageSend event fired üöÄüöÄüöÄ"),console.log("Event object:",e),console.log("üìÖ Timestamp:",(new Date).toISOString()),console.log("üîß validateEmail function loaded and called"),console.log("üéØ Event type:",_typeof(e)),console.log("üéØ Event completed function:",_typeof(null==e?void 0:e.completed)),console.log("üö® SHOWING ALERT TO CONFIRM VALIDATION IS CALLED"),window.lastValidationEvent=e,validationState.validationInProgress=!1,e){if(!Office.context||!Office.context.mailbox||!Office.context.mailbox.item)return console.error("‚ùå Office context not available"),void(e&&"function"==typeof e.completed&&e.completed({allowEvent:!0}));Office.context.mailbox.item.body.getAsync("text",(function(t){if(t.status===Office.AsyncResultStatus.Failed)return console.error("Failed to get email body:",t.error),void e.completed({allowEvent:!0});var o=t.value.toLowerCase();console.log("üìß Email body length:",o.length),console.log("üìß Email body preview:",o.substring(0,200)+"..."),validationState.lastEmailBody=o,validationState.lastValidationTime=Date.now();var n=[];Object.keys(REQUIRED_KEYWORDS).forEach((function(e){var t=REQUIRED_KEYWORDS[e];t.keywords.some((function(e){return o.includes(e.toLowerCase())}))||n.push({category:t.category,suggestions:t.suggestions,key:e})})),console.log("üîç Missing keywords found:",n.length),n.length>0?(console.log("‚ùå Missing categories:",n.map((function(e){return e.category}))),console.log("üéØ SHOWING VALIDATION DIALOG FOR INCOMPLETE EMAIL"),validationState.validationInProgress=!0,showValidationDialog(n,e)):(console.log("‚úÖ All keywords present, allowing send"),e&&"function"==typeof e.completed&&e.completed({allowEvent:!0})),setTimeout((function(){console.log("‚è∞ Validation timeout fallback - ensuring event completion"),e&&"function"==typeof e.completed&&!validationState.validationInProgress&&e.completed({allowEvent:!0})}),3e4)}))}else console.error("‚ùå No event object provided to validateEmail")}function showValidationDialog(e,t){var o=getDialogUrl();console.log("üîç Opening validation dialog:",o),console.log("üìä Missing keywords data:",e),console.log("üéØ Event object available:",!!t),Office.context.ui.displayDialogAsync(o,{height:60,width:50,displayInIframe:!0},(function(o){if(o.status===Office.AsyncResultStatus.Failed)return console.error("‚ùå Failed to open dialog:",o.error),void t.completed({allowEvent:!0});console.log("‚úÖ Dialog opened successfully");var n=o.value;setTimeout((function(){console.log("üì§ Sending data to dialog:",e),n.messageChild(JSON.stringify({type:"missing-keywords",data:e}))}),1e3),n.addEventHandler(Office.EventType.DialogMessageReceived,(function(e){console.log("üì• Dialog response received:",e.message);var o=JSON.parse(e.message);if(validationState.validationInProgress=!1,"send"===o.action){if(console.log("‚úÖ User chose to send anyway - ALLOWING SEND"),t&&"function"==typeof t.completed)try{t.completed({allowEvent:!0}),console.log("‚úÖ event.completed({ allowEvent: true }) called successfully")}catch(e){console.error("‚ùå Error calling event.completed for send:",e)}}else if("add-keywords"===o.action)console.log("üîß User wants to add keywords:",o.keywords),addKeywordsToEmail(o.keywords,t);else if("cancel"===o.action){if(console.log("‚ùå User cancelled - BLOCKING SEND"),console.log("üö´ Event completion with allowEvent: false"),console.log("üéØ About to call event.completed({ allowEvent: false })"),t&&"function"==typeof t.completed)try{t.completed({allowEvent:!1}),console.log("‚úÖ event.completed({ allowEvent: false }) called successfully")}catch(e){console.error("‚ùå Error calling event.completed:",e)}}else if(console.log("‚ùì Unknown action:",o.action,"- BLOCKING SEND"),console.log("üö´ Event completion with allowEvent: false for unknown action"),t&&"function"==typeof t.completed)try{t.completed({allowEvent:!1}),console.log("‚úÖ event.completed({ allowEvent: false }) called successfully for unknown action")}catch(e){console.error("‚ùå Error calling event.completed for unknown action:",e)}console.log("üîí Closing dialog"),n.close()})),n.addEventHandler(Office.EventType.DialogEventReceived,(function(e){console.error("‚ùå Dialog error:",e.error),validationState.validationInProgress=!1,t.completed({allowEvent:!0})}))}))}function addKeywordsToEmail(e,t){console.log("üîß ADD KEYWORDS TO EMAIL TRIGGERED"),console.log("üìù Selected keywords:",e),console.log("üéØ Event object available:",!!t);var o=Office.context.mailbox.item;o.body.getAsync("text",(function(n){if(n.status===Office.AsyncResultStatus.Failed)return console.error("Failed to get email body for keyword addition:",n.error),void(t&&"function"==typeof t.completed&&t.completed({allowEvent:!1}));var i=n.value;console.log("üìß Current email body:",i.substring(0,200)+"...");var a=o.conversationId&&o.conversationId.length>0;console.log("üì® Is reply:",a);var r=e.join(", "),l="";try{l=o.subject||""}catch(e){console.log("Could not get email subject:",e)}var s="Please rewrite this email to include these missing elements: ".concat(r,'. \n\nIMPORTANT CONTEXT:\n- Email Subject: "').concat(l,'"\n- Original email content: "').concat(i,'"\n\nPlease create a complete, professional email that:\n1. Maintains the ORIGINAL INTENT and context (sick leave, meeting, etc.)\n2. Includes the missing elements: ').concat(r,'\n3. Is appropriate for the subject matter\n4. Has a proper greeting and closing\n5. Is professional but matches the original tone\n\nDO NOT generate a generic meeting template. Instead, enhance the original email while keeping its specific purpose and context.\n\nOriginal email: "').concat(i,'"\nSubject: "').concat(l,'"\n\nPlease rewrite this as a complete, professional email that maintains the original intent.');console.log("ü§ñ Enhancement prompt:",s.substring(0,300)+"...");var c={chooseATask:"emailResponse",emailContent:s,tone:"professional",pointOfView:"organizationPerspective",additionalInstructions:"Focus on incorporating missing keywords naturally while maintaining the original message intent",anonymize:null,incognito:!1,default_language:"en-US",should_stream:!1};if(console.log("üöÄ Calling BotAtWork API for email enhancement..."),console.log("üìß Email subject:",l),console.log("üìù Original content:",i),"function"==typeof getSuggestedReply){console.log("‚úÖ getSuggestedReply function available");var d=s;(l.toLowerCase().includes("sick")||l.toLowerCase().includes("leave")||i.toLowerCase().includes("sick")||i.toLowerCase().includes("leave"))&&(d="Please rewrite this SICK LEAVE email to include these missing elements: ".concat(r,'. \n\nIMPORTANT: This is a SICK LEAVE email, not a meeting email.\n\nOriginal email: "').concat(i,'"\nSubject: "').concat(l,'"\n\nPlease create a professional sick leave email that:\n1. Maintains the sick leave context\n2. Includes proper greeting and closing\n3. Clearly states the sick leave request\n4. Includes relevant details (dates, reason if appropriate, contact info)\n5. Is professional and respectful\n\nDO NOT generate a meeting template. This is about sick leave.'),console.log("üè• Detected sick leave context, using specific prompt")),c.emailContent=d,getSuggestedReply(c).then((function(e){if(console.log("üéâ Enhanced content received (full):",e),console.log("üîç Content type:",_typeof(e)),console.log("üîç Content length:",e?e.length:"null"),console.log("üîç Starts with API error?",e?e.startsWith("API error:"):"null"),console.log("üîç Starts with Error calling?",e?e.startsWith("Error calling BotAtWork API:"):"null"),!e||e.startsWith("API error:")||e.startsWith("Error calling BotAtWork API:")){var n=e||"Unknown error occurred";console.error("‚ùå Enhancement failed - content rejected:",n),console.error("‚ùå Content was treated as error because it starts with error prefix"),t&&"function"==typeof t.completed&&t.completed({allowEvent:!1})}else console.log("üìù ATTEMPTING TO UPDATE EMAIL BODY..."),console.log("üìß Item object available:",!!o),console.log("üìß Item.body available:",!!o.body),console.log("üìß Item.body.setAsync available:",!(!o.body||!o.body.setAsync)),o.body.setAsync(e,{coercionType:Office.CoercionType.Text},(function(o){console.log("üìù setAsync callback called"),console.log("üìù setResult status:",o.status),console.log("üìù Expected success status:",Office.AsyncResultStatus.Succeeded),o.status===Office.AsyncResultStatus.Succeeded?(console.log("‚úÖ EMAIL BODY UPDATED SUCCESSFULLY!"),console.log("üéØ Enhanced content was:",e.substring(0,300)+"..."),t&&"function"==typeof t.completed&&t.completed({allowEvent:!1})):(console.error("‚ùå FAILED TO UPDATE EMAIL BODY"),console.error("‚ùå Error details:",o.error),t&&"function"==typeof t.completed&&t.completed({allowEvent:!1}))}))})).catch((function(e){console.error("‚ùå Error calling BotAtWork API:",e),t&&"function"==typeof t.completed&&t.completed({allowEvent:!1})}))}else{var u;console.error("‚ùå getSuggestedReply function not available - using fallback"),l.toLowerCase().includes("sick")||l.toLowerCase().includes("leave")||i.toLowerCase().includes("sick")||i.toLowerCase().includes("leave")?(u="Dear [Manager's Name],\n\nI hope this email finds you well.\n\nI am writing to formally request sick leave.\n\n".concat(i,"\n\nI will ensure that any urgent matters are addressed before my leave, and I will coordinate with my team to minimize any disruption.\n\nPlease let me know if you need any additional information or documentation.\n\nThank you for your understanding.\n\nBest regards,\n[Your Name]"),console.log("üè• Using sick leave fallback enhancement")):(u="Dear Team,\n\nI hope this email finds you well.\n\n".concat(i,"\n\nPlease let me know if you have any questions or need additional information.\n\nThank you for your time and consideration.\n\nBest regards,\n[Your Name]"),console.log("üìß Using general fallback enhancement")),console.log("üîÑ ATTEMPTING FALLBACK EMAIL UPDATE..."),console.log("üìù Fallback content:",u.substring(0,200)+"..."),o.body.setAsync(u,{coercionType:Office.CoercionType.Text},(function(e){console.log("üìù Fallback setAsync callback called"),e.status===Office.AsyncResultStatus.Succeeded?(console.log("‚úÖ EMAIL ENHANCED WITH FALLBACK CONTENT!"),t&&"function"==typeof t.completed&&t.completed({allowEvent:!1})):(console.error("‚ùå FAILED TO UPDATE EMAIL BODY WITH FALLBACK"),console.error("‚ùå Fallback error details:",e.error),t&&"function"==typeof t.completed&&t.completed({allowEvent:!1}))}))}}))}function generateEnhancedEmail(e,t,o,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a=t.join(", "),r=o?"reply":"new email",l="Please enhance this ".concat(r," by naturally incorporating these missing elements: ").concat(a,"\n\nOriginal content:\n").concat(e,"\n\nInstructions:\n- Keep the original tone and intent\n- Naturally integrate the missing elements\n- Make it professional and coherent\n- Don't change the core message, just enhance it with the missing elements\n\nEnhanced ").concat(r,":"),s=i.chooseATask,c=void 0===s?"emailResponse":s,d=i.description,u=void 0===d?l:d,g=(i.emailContent,i.additionalInstructions),f=void 0===g?"":g,m=i.tone,p=void 0===m?"professional":m,y=i.pointOfView,v=void 0===y?"organizationPerspective":y,h=i.anonymize,w=void 0===h?null:h,E=i.incognito,O=void 0!==E&&E,b=i.default_language,A=void 0===b?"en-US":b,I=i.should_stream,S={data:{payload:{chooseATask:c,description:u,additionalInstructions:f,tone:p,pointOfView:v}},anonymize:w,incognito:O,default_language:A,should_stream:void 0!==I&&I};void 0!==getSuggestedReply?(console.log("Using getSuggestedReply with apiParams:",i),getSuggestedReply(u,3,i).then((function(e){n(e)})).catch((function(e){console.error("Failed to generate enhanced email:",e);var t=e.toString();n(t.startsWith("API error:")||t.startsWith("Error calling BotAtWork API:")?t:"Failed to generate enhanced email: ".concat(t))}))):(console.error("getSuggestedReply function not available - falling back to direct API call"),console.log("BotAtWork API Request Body:",JSON.stringify(S,null,2)),fetch(BOTATWORK_API_URL,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":BOTATWORK_API_KEY},body:JSON.stringify(S)}).then((function(e){return e.json()})).then((function(e){console.log("BotAtWork API Response:",e),e&&"SUCCESS"===e.status&&e.data&&e.data.content?n(e.data.content):e&&e.response?n(e.response):(console.error("Invalid response from BotAtWork API:",e),n("API error: Invalid response format from BotAtWork API"))})).catch((function(e){console.error("Failed to generate enhanced email:",e);var t=e.toString();n(t.startsWith("API error:")||t.startsWith("Error calling BotAtWork API:")?t:"Failed to generate enhanced email: ".concat(t))})))}function getDialogUrl(){var e="localhost"===window.location.hostname,t=e?"https://localhost:3000":"https://nayaksubhasish.github.io/MAIL-MAGIC",o="".concat(t,"/validation-dialog.html");return console.log("üîó Dialog URL:",o),console.log("üåê Current hostname:",window.location.hostname),console.log("üîß Is localhost:",e),console.log("üì° Base URL:",t),o}function action(e){var t,o={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"Performed action.",icon:"Icon.80x80",persistent:!0};null===(t=Office.context.mailbox.item)||void 0===t||t.notificationMessages.replaceAsync("ActionPerformanceNotification",o),e.completed()}function validateEmailManual(e){if(console.log("Manual email validation triggered"),!Office.context||!Office.context.mailbox||!Office.context.mailbox.item)return console.error("Office context not available"),void e.completed();Office.context.mailbox.item.body.getAsync("text",(function(t){if(t.status===Office.AsyncResultStatus.Failed)return console.error("Failed to get email body:",t.error),void e.completed();var o=t.value.toLowerCase(),n=[];if(Object.keys(REQUIRED_KEYWORDS).forEach((function(e){var t=REQUIRED_KEYWORDS[e];t.keywords.some((function(e){return o.includes(e.toLowerCase())}))||n.push({category:t.category,suggestions:t.suggestions,key:e})})),n.length>0)showValidationDialogManual(n,e);else{var i,a={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"‚úÖ Email validation passed! All important elements are present.",icon:"Icon.80x80",persistent:!0};null===(i=Office.context.mailbox.item)||void 0===i||i.notificationMessages.replaceAsync("ValidationNotification",a),e.completed()}}))}function showValidationDialogManual(e,t){var o=getDialogUrl();Office.context.ui.displayDialogAsync(o,{height:60,width:50,displayInIframe:!0},(function(o){if(o.status===Office.AsyncResultStatus.Failed)return console.error("Failed to open dialog:",o.error),void t.completed();var n=o.value;setTimeout((function(){n.messageChild(JSON.stringify({type:"missing-keywords",data:e}))}),1e3),n.addEventHandler(Office.EventType.DialogMessageReceived,(function(e){var o=JSON.parse(e.message);if("send"===o.action){var i,a={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"Email validation completed. You can proceed with sending.",icon:"Icon.80x80",persistent:!0};null===(i=Office.context.mailbox.item)||void 0===i||i.notificationMessages.replaceAsync("ValidationNotification",a),t.completed()}else"add-keywords"===o.action?addKeywordsToEmailManual(o.keywords,t):t.completed();n.close()})),n.addEventHandler(Office.EventType.DialogEventReceived,(function(e){console.error("Dialog error:",e.error),t.completed()}))}))}function addKeywordsToEmailManual(e,t){var o=Office.context.mailbox.item;o.body.getAsync("text",(function(n){if(n.status===Office.AsyncResultStatus.Failed)return console.error("Failed to get email body for keyword addition:",n.error),void t.completed();var i=n.value,a=o.conversationId&&o.conversationId.length>0;generateEnhancedEmail(i,e,a,(function(e){if(!e||e.startsWith("API error:")||e.startsWith("Failed to generate enhanced email:")||e.startsWith("Error calling BotAtWork API:")){var n,i=e||"Unknown error occurred";console.error("Enhancement failed:",i);var a={type:Office.MailboxEnums.ItemNotificationMessageType.ErrorMessage,message:i.startsWith("API error:")||i.startsWith("Error calling BotAtWork API:")?i:"Failed to enhance email: ".concat(i),icon:"Icon.80x80",persistent:!0};null===(n=Office.context.mailbox.item)||void 0===n||n.notificationMessages.replaceAsync("ValidationNotification",a),t.completed()}else o.body.setAsync(e,{coercionType:Office.CoercionType.Text},(function(e){if(e.status===Office.AsyncResultStatus.Succeeded){var o;console.log("Email enhanced with keywords");var n={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"‚úÖ Email enhanced with selected keywords!",icon:"Icon.80x80",persistent:!0};null===(o=Office.context.mailbox.item)||void 0===o||o.notificationMessages.replaceAsync("ValidationNotification",n),t.completed()}else console.error("Failed to update email body:",e.error),t.completed()}))}),{chooseATask:"emailWrite",tone:"professional",pointOfView:"organizationPerspective",additionalInstructions:"Enhance the email by naturally incorporating the missing keywords while preserving the original tone and message",anonymize:null,incognito:!1,default_language:"en-US",should_stream:!1})}))}function sendWithValidation(e){if(console.log("Send with validation triggered"),!Office.context||!Office.context.mailbox||!Office.context.mailbox.item)return console.error("Office context not available"),void e.completed();Office.context.mailbox.item.body.getAsync("text",(function(t){if(t.status===Office.AsyncResultStatus.Failed)return console.error("Failed to get email body:",t.error),void e.completed();var o=t.value.toLowerCase(),n=[];Object.keys(REQUIRED_KEYWORDS).forEach((function(e){var t=REQUIRED_KEYWORDS[e];t.keywords.some((function(e){return o.includes(e.toLowerCase())}))||n.push({category:t.category,suggestions:t.suggestions,key:e})})),n.length>0?showSendValidationDialog(n,e):sendEmail(e)}))}function showSendValidationDialog(e,t){var o=getDialogUrl();Office.context.ui.displayDialogAsync(o,{height:60,width:50,displayInIframe:!0},(function(o){if(o.status===Office.AsyncResultStatus.Failed)return console.error("Failed to open dialog:",o.error),void t.completed();var n=o.value;setTimeout((function(){n.messageChild(JSON.stringify({type:"missing-keywords",data:e,mode:"send"}))}),1e3),n.addEventHandler(Office.EventType.DialogMessageReceived,(function(e){var o=JSON.parse(e.message);"send"===o.action?sendEmail(t):"add-keywords"===o.action?addKeywordsAndSend(o.keywords,t):t.completed(),n.close()})),n.addEventHandler(Office.EventType.DialogEventReceived,(function(e){console.error("Dialog error:",e.error),t.completed()}))}))}function addKeywordsAndSend(e,t){var o=Office.context.mailbox.item;o.body.getAsync("text",(function(n){if(n.status===Office.AsyncResultStatus.Failed)return console.error("Failed to get email body for keyword addition:",n.error),void t.completed();var i=n.value,a=o.conversationId&&o.conversationId.length>0;generateEnhancedEmail(i,e,a,(function(e){if(!e||e.startsWith("API error:")||e.startsWith("Failed to generate enhanced email:")||e.startsWith("Error calling BotAtWork API:")){var n,i=e||"Unknown error occurred";console.error("Enhancement failed:",i);var a={type:Office.MailboxEnums.ItemNotificationMessageType.ErrorMessage,message:i.startsWith("API error:")||i.startsWith("Error calling BotAtWork API:")?"".concat(i," Send anyway?"):"Failed to enhance email: ".concat(i,". Send anyway?"),icon:"Icon.80x80",persistent:!0};null===(n=Office.context.mailbox.item)||void 0===n||n.notificationMessages.replaceAsync("ValidationNotification",a),t.completed()}else o.body.setAsync(e,{coercionType:Office.CoercionType.Text},(function(e){e.status===Office.AsyncResultStatus.Succeeded?(console.log("Email enhanced with keywords, now sending..."),sendEmail(t)):(console.error("Failed to update email body:",e.error),t.completed())}))}),{chooseATask:"emailWrite",tone:"professional",pointOfView:"organizationPerspective",additionalInstructions:"Quickly enhance the email with missing keywords and prepare it for sending while maintaining professional tone",anonymize:null,incognito:!1,default_language:"en-US",should_stream:!1})}))}function sendEmail(e){if(Office.context&&Office.context.mailbox&&Office.context.mailbox.item){var t,o={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"‚úÖ Email validation completed. Sending email...",icon:"Icon.80x80",persistent:!1};null===(t=Office.context.mailbox.item)||void 0===t||t.notificationMessages.replaceAsync("ValidationNotification",o),Office.context.mailbox.item.saveAsync((function(e){if(e.status===Office.AsyncResultStatus.Succeeded){var t,o={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"‚úÖ Email ready to send! Please click the Send button in Outlook.",icon:"Icon.80x80",persistent:!0};null===(t=Office.context.mailbox.item)||void 0===t||t.notificationMessages.replaceAsync("SendNotification",o)}}))}e.completed()}Office.onReady((function(){console.log("Office.js is ready - registering email validation"),window.validateEmail=validateEmail,console.log("validateEmail function registered globally")})),window.validateEmail=validateEmail,window.action=action,console.log("üîß Registering Office.actions functions..."),Office.actions.associate("action",action),console.log("‚úÖ action function registered"),Office.actions.associate("validateEmail",validateEmail),console.log("‚úÖ validateEmail function registered"),Office.actions.associate("validateEmailManual",validateEmailManual),console.log("‚úÖ validateEmailManual function registered"),Office.actions.associate("sendWithValidation",sendWithValidation),console.log("‚úÖ sendWithValidation function registered"),console.log("üîß Attempting alternative ItemSend registration...");try{Office.context&&Office.context.mailbox&&console.log("‚úÖ Office context available for alternative registration")}catch(e){console.error("‚ùå Error in alternative registration:",e)}function testValidation(){console.log("üß™ Testing validation manually"),validateEmail({completed:function(e){console.log("‚úÖ Test validation completed:",e)}})}function resetValidationState(){console.log("üîÑ Resetting validation state"),validationState={lastValidationTime:0,lastEmailBody:"",validationInProgress:!1},console.log("‚úÖ Validation state reset:",validationState)}function checkValidationState(){return console.log("üìä Current validation state:",validationState),validationState}function checkValidationRegistration(){var e,t;console.log("üîç Checking validation registration..."),console.log("‚úÖ validateEmail function exists:","function"==typeof validateEmail),console.log("‚úÖ Office context available:",!!Office.context),console.log("‚úÖ Mailbox available:",!(null===(e=Office.context)||void 0===e||!e.mailbox)),console.log("‚úÖ Current validation state:",validationState),console.log("üéØ Last validation event:",window.lastValidationEvent),null!==(t=Office.context)&&void 0!==t&&null!==(t=t.mailbox)&&void 0!==t&&t.item?(console.log("‚úÖ Email item accessible"),Office.context.mailbox.item.body.getAsync("text",(function(e){e.status===Office.AsyncResultStatus.Succeeded?console.log("‚úÖ Email body accessible, length:",e.value.length):console.log("‚ùå Email body not accessible:",e.error)}))):console.log("‚ùå Email item not accessible")}function testEventCompletion(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(console.log("üß™ Testing event completion with allowEvent:",e),window.lastValidationEvent){console.log("üéØ Using last validation event");try{window.lastValidationEvent.completed({allowEvent:e}),console.log("‚úÖ Manual event.completed called successfully")}catch(e){console.error("‚ùå Error in manual event.completed:",e)}}else console.log("‚ùå No validation event available for testing")}window.testValidation=testValidation,window.resetValidationState=resetValidationState,window.checkValidationState=checkValidationState,window.checkValidationRegistration=checkValidationRegistration,window.testEventCompletion=testEventCompletion;